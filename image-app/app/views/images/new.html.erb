<h1>写真アップロード</h1>

<div class="p-5">
  <div class="p-5">
    <%= form_with model: @image, url: images_path, method: :post, html: { id: "image-form" } do |form| %>
      <div class="p-5">
        <%= form.label :title, "タイトル" %>
        <%= form.text_field :title, id: "image-title" %>
      </div>
      <div class="p-5">
        <%= form.label :file, "画像" %>
        <%= form.file_field :file, id: "image-file" %>
      </div>
      <div class="p-5">
        <div id="form-errors" style="color:#c00"></div>
      </div>
      <div class="p-5">
        <%= form.submit "アップロード", type: "button", id: "submit-btn" %>
      </div>
    <% end %>
  </div>
</div>

<div style="margin-top: 10px;">
  <%= link_to "キャンセル", root_path %>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("image-form");
  const fileInput = document.getElementById("image-file");
  const titleInput = document.getElementById("image-title");
  const submitBtn = document.getElementById("submit-btn");
  const errBox = document.getElementById("form-errors");

  fileInput.addEventListener("change", (e) => {
    errBox.textContent = "";
  });

  titleInput.addEventListener("input", (e) => {
    errBox.textContent = "";
  });

  submitBtn.addEventListener("click", async (e) => {
    submitBtn.disabled = true;
    errBox.textContent = "";

    try {
      const title = titleInput.value;
      if (!title) { errBox.textContent = "タイトルを入力してください"; return; }
      if (title.length > 30) { errBox.textContent = "タイトルは30文字以内で入力してください"; return; }

      const file = fileInput.files[0];
      if (!file) { errBox.textContent = "ファイルを選択してください"; return; }

      form.requestSubmit();
    } catch (e) {
      errBox.textContent = "エラーが発生しました";
      console.error(e);
    } finally {
      submitBtn.disabled = false;
    }
  });
});
</script>
